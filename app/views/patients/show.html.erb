<div class="patient-show">
  <div class="patient-header">
    <h1><%= @patient.first_name %> <%= @patient.last_name %></h1>
    <div class="actions">
      <%= link_to "Editar", edit_patient_path(@patient) %>
      <%= link_to "Volver", patients_path %>
    </div>
  </div>

  <!-- Información básica del paciente -->
  <section class="patient-info">
    <h2>Información Personal</h2>
    <table>
      <tr>
        <th>Email:</th>
        <td><%= @patient.email %></td>
      </tr>
      <tr>
        <th>Teléfono:</th>
        <td><%= @patient.phone || "-" %></td>
      </tr>
      <tr>
        <th>Peso:</th>
        <td><%= @profile&.weight ? "#{@profile.weight} kg" : "-" %></td>
      </tr>
      <tr>
        <th>Altura:</th>
        <td><%= @profile&.height ? "#{@profile.height} cm" : "-" %></td>
      </tr>
      <tr>
        <th>Objetivos:</th>
        <td><%= @profile&.goals || "-" %></td>
      </tr>
      <tr>
        <th>Condiciones:</th>
        <td><%= @profile&.conditions || "-" %></td>
      </tr>
      <tr>
        <th>Estilo de vida:</th>
        <td><%= @profile&.lifestyle || "-" %></td>
      </tr>
    </table>
  </section>

  <!-- Planes nutricionales -->
  <section class="nutrition-plans">
    <div class="section-header">
      <h2>Planes Nutricionales (<%= @nutrition_plans.count %>)</h2>
      <%= link_to "Nuevo Plan", new_patient_nutrition_plan_path(@patient) %>
    </div>

    <% if @nutrition_plans.any? %>
      <table>
        <thead>
          <tr>
            <th>Objetivo</th>
            <th>Calorías</th>
            <th>Proteína</th>
            <th>Grasas</th>
            <th>Carbos</th>
            <th>Estado</th>
            <th>Creado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <% @nutrition_plans.each do |plan| %>
            <tr>
              <td><%= plan.objective %></td>
              <td><%= plan.calories ? "#{plan.calories} kcal" : "-" %></td>
              <td><%= plan.protein ? "#{plan.protein}g" : "-" %></td>
              <td><%= plan.fat ? "#{plan.fat}g" : "-" %></td>
              <td><%= plan.carbs ? "#{plan.carbs}g" : "-" %></td>
              <td><%= plan.status || "Activo" %></td>
              <td><%= plan.created_at.strftime("%d/%m/%Y") %></td>
              <td>
                <%= link_to "Ver", patient_nutrition_plan_path(@patient, plan) %>
                <%= link_to "Editar", edit_patient_nutrition_plan_path(@patient, plan) %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p>No hay planes nutricionales registrados.</p>
    <% end %>
  </section>

  <!-- Historial de visitas -->
  <section class="patient-histories">
    <h2>Historial de Visitas (<%= @patient_histories.count %>)</h2>

    <% if @patient_histories.any? %>
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Peso</th>
            <th>Notas</th>
            <th>Nutricionista</th>
          </tr>
        </thead>
        <tbody>
          <% @patient_histories.each do |history| %>
            <tr>
              <td><%= history.visit_date.strftime("%d/%m/%Y") %></td>
              <td><%= history.weight ? "#{history.weight} kg" : "-" %></td>
              <td><%= history.notes&.truncate(50) || "-" %></td>
              <td><%= history.nutritionist&.first_name %> <%= history.nutritionist&.last_name %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p>No hay visitas registradas.</p>
    <% end %>
  </section>

  <!-- Registro de comidas (últimas 10) -->
  <section class="meal-logs">
    <div class="section-header">
      <h2>Registro de Comidas (últimas 10)</h2>
      <%= link_to "Ver todos", patient_meal_logs_path(@patient) %>
    </div>

    <% if @meal_logs.any? %>
      <table>
        <thead>
          <tr>
            <th>Fecha/Hora</th>
            <th>Calorías (IA)</th>
            <th>Macros (IA)</th>
            <th>Puntaje</th>
            <th>Feedback</th>
          </tr>
        </thead>
        <tbody>
          <% @meal_logs.each do |meal| %>
            <tr>
              <td><%= meal.logged_at.strftime("%d/%m/%Y %H:%M") %></td>
              <td><%= meal.ai_calories ? "#{meal.ai_calories} kcal" : "-" %></td>
              <td>
                <% if meal.ai_macros %>
                  P: <%= meal.ai_macros['protein'] %>g
                  G: <%= meal.ai_macros['fat'] %>g
                  C: <%= meal.ai_macros['carbs'] %>g
                <% else %>
                  -
                <% end %>
              </td>
              <td><%= meal.ai_health_score || "-" %></td>
              <td><%= meal.ai_feedback&.truncate(40) || "-" %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p>No hay registro de comidas.</p>
    <% end %>
  </section>

  <!-- Check-ins diarios (últimos 7) -->
  <section class="daily-check-ins">
    <div class="section-header">
      <h2>Check-ins Diarios (últimos 7)</h2>
      <%= link_to "Ver todos", patient_daily_check_ins_path(@patient) %>
    </div>

    <% if @daily_check_ins.any? %>
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Peso</th>
            <th>Energía</th>
            <th>Humor</th>
            <th>Adherencia</th>
            <th>Notas</th>
          </tr>
        </thead>
        <tbody>
          <% @daily_check_ins.each do |checkin| %>
            <tr>
              <td><%= checkin.date.strftime("%d/%m/%Y") %></td>
              <td><%= checkin.weight ? "#{checkin.weight} kg" : "-" %></td>
              <td><%= checkin.energy_level || "-" %></td>
              <td><%= checkin.mood || "-" %></td>
              <td>
                <% adherence_count = [checkin.breakfast_adherence, checkin.lunch_adherence, checkin.dinner_adherence, checkin.snack_adherence].count(true) %>
                <%= "#{adherence_count}/4 comidas" %>
              </td>
              <td><%= checkin.notes&.truncate(30) || "-" %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p>No hay check-ins registrados.</p>
    <% end %>
  </section>
</div>
