<%# encoding: UTF-8 %>
<% content_for :hide_navbar, true %>
<div class="container-fluid p-0 bg-light min-vh-100">
  <div class="mx-auto bg-white shadow" style="max-width: 448px;">

    <%= simple_form_for [@meal, @meal_log], html: { class: "d-flex flex-column min-vh-100", multipart: true } do |f| %>

      <!-- Header -->
      <header class="p-4 position-relative bg-white border-bottom">
        <%= link_to pats_dashboard_path, class: "position-absolute start-0 top-0 mt-4 ms-3 text-dark text-decoration-none" do %>
          <i class="bi bi-arrow-left fs-4"></i>
        <% end %>
        <h1 class="fs-5 fw-semibold text-dark text-center mb-0">Registrar comida</h1>
      </header>

      <!-- Main Content -->
      <main class="flex-grow-1 px-4 pb-4 pt-3">

        <!-- Camera Upload Area -->
        <div class="bg-light rounded-4 mb-4 d-flex flex-column align-items-center justify-content-center position-relative" style="min-height: 300px;" id="photo-upload-area">
          
          <!-- Hidden file input -->
          <%= f.input :photo, 
                      as: :file, 
                      label: false,
                      input_html: { 
                        accept: 'image/*',
                        capture: 'environment',
                        class: 'd-none',
                        id: 'photo-input',
                        onchange: 'previewImage(event)'
                      },
                      wrapper_html: { class: 'd-none' } %>

          <!-- Preview Image Container -->
          <div id="image-preview" class="d-none w-100 h-100 position-absolute top-0 start-0">
            <img id="preview-img" src="" class="w-100 h-100 object-fit-cover rounded-4" style="max-height: 300px;" alt="Preview">
          </div>

          <!-- Camera Button (shown when no image) -->
          <div id="camera-placeholder" class="d-flex flex-column align-items-center justify-content-center w-100 h-100">
            <label for="photo-input" class="btn btn-white bg-white rounded-circle shadow-sm p-0 border-0 mb-3 d-flex align-items-center justify-content-center" style="width: 100px; height: 100px; cursor: pointer;">
              <i class="bi bi-camera-fill text-success" style="font-size: 2.5rem;"></i>
            </label>
            <label for="photo-input" class="btn btn-link text-secondary text-decoration-none d-flex align-items-center gap-2" style="cursor: pointer;">
              <i class="bi bi-image"></i>
              <span class="small">Subir de la galería</span>
            </label>
          </div>
        </div>

        <!-- Meal Info -->
        <div class="bg-white border rounded-3 p-3 mb-3 shadow-sm">
          <div class="row">
            <div class="col-6">
              <p class="small text-secondary mb-1 fw-medium">Tipo de comida</p>
              <p class="fw-semibold text-dark mb-0"><%= @meal.meal_type&.humanize || "Comida" %></p>
            </div>
            <div class="col-6 text-end">
              <p class="small text-secondary mb-1 fw-medium">Comida planificada</p>
              <p class="fw-semibold text-dark mb-0"><%= @meal.calories&.round || 0 %> kcal</p>
            </div>
          </div>
        </div>

        <!-- Instructions -->
        <div class="bg-white border rounded-3 p-3 shadow-sm">
          <div class="d-flex align-items-start gap-2">
            <i class="bi bi-info-circle text-success mt-1"></i>
            <p class="small mb-0 text-dark lh-base">
              Toma una foto de tu comida. Nuestra IA la analizará y comparará con tu plan nutricional.
            </p>
          </div>
        </div>

      </main>

      <!-- Sticky Footer Button -->
      <footer class="sticky-bottom bg-white border-top p-3">
        <%= f.button :submit, 
                     "Analizar y Registrar", 
                     class: "btn btn-dark w-100 py-3 rounded-3 fw-semibold shadow-sm",
                     id: "submit-btn",
                     disabled: true,
                     data: { disable_with: "Analizando con IA..." } %>
      </footer>

    <% end %>

  </div>
</div>

<script>
  function previewImage(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('preview-img').src = e.target.result;
        document.getElementById('image-preview').classList.remove('d-none');
        document.getElementById('camera-placeholder').classList.add('d-none');
        document.getElementById('submit-btn').disabled = false;
      }
      reader.readAsDataURL(file);
    }
  }
</script>

<style>
  #photo-upload-area {
    position: relative;
    overflow: hidden;
  }

  #camera-placeholder {
    z-index: 1;
  }

  #image-preview {
    z-index: 2;
  }
</style>
