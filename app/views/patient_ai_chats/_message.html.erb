<div class="message <%= message.role %>-message">
  <div class="message-role">
    <%= message.user? ? "T√∫" : "Asistente" %>
  </div>
  <div class="message-content">
    <%= simple_format(message.content) %>
  </div>

  <% if message.assistant? && message.metadata.present? %>
    <div class="message-metadata">
      <div>
        <small>
          Tiempo de respuesta: <%= message.metadata["response_time_ms"] %>ms
          <% if message.metadata["tools_called"]&.any? %>
            | Herramientas: <%= message.metadata["tools_called"].join(", ") %>
          <% end %>
        </small>
      </div>

      <% if message.metadata["safety_flags"].present? %>
        <% safety_flags = message.metadata["safety_flags"] %>
        <% if safety_flags.values.any? %>
          <div class="mt-2">
            <% if safety_flags["off_topic"] %>
              <span class="safety-flag warning">‚ö†Ô∏è Tema fuera de nutrici√≥n</span>
            <% end %>
            <% if safety_flags["medical_advice_detected"] %>
              <span class="safety-flag warning">‚ö†Ô∏è Consulta m√©dica detectada</span>
            <% end %>
            <% if safety_flags["plan_deviation_suggested"] %>
              <span class="safety-flag warning">‚ö†Ô∏è Posible desviaci√≥n del plan</span>
            <% end %>
            <% if safety_flags["negative_sentiment"] %>
              <span class="safety-flag">üí≠ Apoyo emocional</span>
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div>
  <% end %>
</div>
