<div id="message_<%= message.id %>" class="mb-3 <%= message.role == 'user' ? 'text-end' : '' %>">
  <div class="d-inline-block <%= message.role == 'user' ? 'bg-primary text-white' : 'bg-light' %> rounded p-3" style="max-width: 70%;">
    <% if message.role == 'user' %>
      <strong>Tú:</strong>
    <% else %>
      <strong>🤖 Asistente:</strong>
    <% end %>
    <div class="mt-1" style="white-space: pre-wrap;">
      <%= message.content %>
      <% if defined?(streaming) && streaming %>
        <span class="spinner-border spinner-border-sm ms-2" role="status">
          <span class="visually-hidden">Escribiendo...</span>
        </span>
      <% end %>
    </div>

    <% if message.role == 'assistant' && message.metadata.present? %>
      <div class="mt-2 pt-2 border-top border-<%= message.role == 'user' ? 'white' : 'secondary' %>" style="font-size: 0.75rem;">
        <div class="text-<%= message.role == 'user' ? 'white-50' : 'muted' %>">
          ⏱️ <%= message.metadata["response_time_ms"] %>ms
          <% if message.metadata["tools_called"]&.any? %>
            | 🔧 <%= message.metadata["tools_called"].join(", ") %>
          <% end %>
        </div>

        <% if message.metadata["safety_flags"]&.values&.any? %>
          <div class="mt-1">
            <% flags = message.metadata["safety_flags"] %>
            <% if flags["potentially_harmful_advice"] %>
              <span class="badge bg-danger">⚠️ Consejo potencialmente dañino</span>
            <% end %>
            <% if flags["data_privacy_concern"] %>
              <span class="badge bg-warning text-dark">🔒 Privacidad de datos</span>
            <% end %>
            <% if flags["excessive_tool_usage"] %>
              <span class="badge bg-info text-dark">🔧 Uso excesivo de herramientas</span>
            <% end %>
            <% if flags["response_quality_low"] %>
              <span class="badge bg-secondary">📉 Calidad de respuesta baja</span>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>

    <small class="text-<%= message.role == 'user' ? 'white-50' : 'muted' %> d-block mt-1">
      <%= message.created_at.strftime('%H:%M') %>
    </small>
  </div>
</div>
